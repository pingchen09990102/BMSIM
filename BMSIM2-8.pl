#!/usr/bin/perl
use strict;
use warnings;
use List::Util qw/sum/;
#use Bio::DB::Fasta####建立fa索引
use Math::Random qw(:all);#链接所有随机数模块
use Math::Random::MT qw(srand rand);
use Getopt::Long;
use Pod::Usage;
#找自写模块
use FindBin qw($Bin);
use lib "$Bin/lib";
#自写模块
use Chimera;
use ErrorMOD;
use Digest;#不同酶切用不同模块
use RES;
use Fragile;

#####################################
#example：
#
#	
#  nohup perl ../BMSIM2-5.pl -cov 10 -p PLsimCov350 -ca /home/bionano/BMSIM/MG1655.fa -bnx /home/bionano/BMSIM/PLsim/PLsimCov350.bnx -fragile /home/bionano/BMSIM/PLsim/MG1655.txt -e GCTCTTC,GAAGAGC -np1 7 >log.txt &
#
#
########################################


my $start_time=time();#记录开始时间

my ($out1,$out2,$Cov,$chr_fa,$bnx,$FragileIN,$str,$RtI,$RtII,$snr,$Ints,$out3,$out4,$out5,$out6,$out7,$e,$np1,$np2,$FragileArg);

my $man = 0;
my $help = 0;
my $version = 0;
my $EXPav = 70;
my $p_FN = 0.85;
my $lamdaFP = 100;
my $res=2;
my $Chi_perc=0.1;
my $Chi_Bi=0.85;
my $Chi_Tri=0.13;
my $Chi_Qua=0.02;
my $ProName="out";

GetOptions (
			  'help|h' => \$help,
              'version' => \$version,
			  'man' => \$man,
              'cov|Coverage:i' => \$Cov,
              'ca|chr_fa:s' => \$chr_fa,#fa input
              'bnx|bnx_outfile:s' => \$bnx,#bnx output
			  'fragile|Fragile_infile:s' => \$FragileIN,#Fragile Input
			  'lm|length_mean:f' => \$EXPav,#possion
              'FNp|FN_probality:f' => \$p_FN,#add FN, enzyme nick effiency
              'FPi|FP_intensity:f' => \$lamdaFP,#add FP, possion
              'str|stretch_normal:s' => \$str,#stretch~N(ave,std),comma-separated lists of values

			  'Rt|Res_type:i' => \$res,
              'RtI|Res_typeI:s' => \$RtI,#type I, under1000,under1500
			  'RtII|Res_typeII:s' => \$RtII,#type II, resolution~N(ave,std)

			  'snr|SNR:s' => \$snr,#type II, SNR~N(ave,std)
			  'Ints|Intensity:s' => \$Ints,#type II, Intensity~N(ave,std)

			  'Chi_perc|Chi_percent:f' => \$Chi_perc,
              'Chi_Bi|Chi_Bi:f' => \$Chi_Bi,
              'Chi_Tri|Chi_Tri:f' => \$Chi_Tri,
			  'Chi_Qua|Chi_Qua:f' => \$Chi_Qua,

			  'e|enzymes_pattern:s' => \$e,#enzyme recognized pattern split with comma
			  'np1|nick_position1:i' => \$np1,#5' to 3', nicking position of the enzyme pattern所缺碱基与第一个碱基间距碱基数
			  'np2|nick_position2:i' => \$np2,#nicking position of the enzyme pattern所缺碱基与第一个碱基间距碱基数

              'p|proj:s' => \$ProName,

              'f|FragileArg:s' => \$FragileArg

              )  
or pod2usage(2);
pod2usage(1) if $help;
pod2usage(-exitstatus => 0, -verbose => 2) if $man;
if ($version)
{
    print "BMSIM Version 1.0.0\n";
    exit;
}
#if no new argument input(split with comma), keep the argument default
my ($m_str,$sd_str,$under1000,$under1500,$ResMean,$ResSdt,$QX11av,$QX11sd,$QX12av,$QX12sd,$enzyme_len,$plus1,$minus1,$plus2,$minus2,$FragilePa,$FragilePb);
my @Str_arguments=(0.98,0.08);#stretch default arguments
if ($str)
{
    @Str_arguments = split(/,/,$str);
	$m_str=$Str_arguments[0];
	$sd_str=$Str_arguments[1];
}
else
{
	$m_str=$Str_arguments[0];
	$sd_str=$Str_arguments[1];
}
#'RtI|Res_typeI:s' => \$RtI,#type I, under1000,under1500
my @RtI_arguments=(0,0.9);#resolution type I default arguments
if ($RtI)
{
    @RtI_arguments = split(/,/,$RtI);
	$under1000=$RtI_arguments[0];
	$under1500=$RtI_arguments[1];
}
else
{
	$under1000=$RtI_arguments[0];
	$under1500=$RtI_arguments[1];
}
#'RtII|Res_typeII:s' => \$RtII,#type II, resolution~N(ave,std)
my @RtII_arguments=(1.2,0.9);#resolution type II default arguments
if ($RtII)
{
    @RtII_arguments = split(/,/,$RtII);
	$ResMean=$RtII_arguments[0];
	$ResSdt=$RtII_arguments[1];
}
else
{
	$ResMean=$RtII_arguments[0];
	$ResSdt=$RtII_arguments[1];
}
#'snr|SNR:s' => \$snr,#type II, SNR~N(ave,std)
my @snr_arguments=(3,0.66);#snr default arguments
if ($snr)
{
    @snr_arguments = split(/,/,$snr);
	$QX11av=$snr_arguments[0];
	$QX11sd=$snr_arguments[1];
}
else
{
	$QX11av=$snr_arguments[0];
	$QX11sd=$snr_arguments[1];
}
#'Ints|Intensity:s' => \$Ints,#type II, Intensity~N(ave,std)
my @Ints_arguments=(1,0.2);#intensity default arguments
if ($Ints)
{
    @Ints_arguments = split(/,/,$Ints);
	$QX12av=$Ints_arguments[0];
	$QX12sd=$Ints_arguments[1];
}
else
{
	$QX12av=$Ints_arguments[0];
	$QX12sd=$Ints_arguments[1];
}

#'e|enzymes_pattern:s' => \$enzymes,
my @e_arguments=("GCTCTTC","GAAGAGC");#e default arguments

#my @enzymes=split(/,/,$e);
#my $enzyme_len=@enzymes;
if ($e)#single 
{
    @e_arguments = split(/,/,$e);
	$enzyme_len=@e_arguments;
	print "$enzyme_len\n";
	if ($enzyme_len==2) #single
		{
			#die "Option -np1 or --nick_position1 must be specified with new enzyme.\n" unless $np1; # report missing required variables
			$plus1=$e_arguments[0];
			$minus1=$e_arguments[1];
			#$nickpos1=$np1;
		}
	else #dual
		{
			die "Option -np1 or --nick_position1 must be specified with new enzyme1.\n" unless $np1; # report missing required variables
			die "Option -np2 or --nick_position2 must be specified with new enzyme2.\n" unless $np2; # report missing required variables
			$plus1=$e_arguments[0];
			$minus1=$e_arguments[1];
			$plus2=$e_arguments[2];
			$minus2=$e_arguments[3];
		}
}
else #default single
{
	$plus1=$e_arguments[0];
	$minus1=$e_arguments[1];
	$np1=7;
	$enzyme_len=2;
}
print "$plus1\t$minus1\t$np1\n";
#'f|FragileArg:s' => \$FragileArg
my @f_arguments=(0.7758,-0.006984);#Fragile default arguments a,b
if ($FragileArg)
{
    @f_arguments = split(/,/,$FragileArg);
	$FragilePa=$f_arguments[0];
	$FragilePb=$f_arguments[1];
}
else
{
	$FragilePa=$f_arguments[0];
	$FragilePb=$f_arguments[1];
}

#检测必须输入的参数是否已经输入
die "Option -ca or --assembly_dir not specified.\n" unless $chr_fa; # report missing required variables
die "Option -bnx or --proj not specified.\n" unless $bnx; # report missing required variables
#print "$FragileIN\n";
die "Option -fragile or --genome not specified.\n" unless $FragileIN; # report missing required variables
die "Option -cov or --ref not specified.\n" unless $Cov; # report missing required variables


#切割基因组染色体一条条单独切割
#open (OUT1, ">$out1")or die "can't open $out1 !";#输出切割后的fa文件
#open (OUT2, ">$out2")or die "can't open $out2 !";#输出切割后的fa长度文件
#open (CMAP, ">$out3")or die "can't open $out3 !";#输出切割后的fa长度文件
#open (FN, ">$out4")or die "can't open $out4 !";#输出切割后的fa长度文件
#open (FP, ">$out5")or die "can't open $out5 !";#输出切割后的fa长度文件
#open (STRETCH, ">$out6")or die "can't open $out6 !";#输出切割后的fa长度文件
#open (Chi, ">$out7")or die "can't open $out7 !";#输出切割后的fa长度文件

####创建BNX文件######
open (BNX, ">$bnx")or die "can't open $bnx !";

###add output bnx file head###
print BNX "# BNX File Version:	1\n";
print BNX "# Label Channels:	1\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							
print BNX "# Nickase Recognition Site 1:\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								
print BNX "# Min Molecule Length (Kb):	0\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							
print BNX "# Label SNR Filter Type:	0\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							
print BNX "# Min Label SNR:	0\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							
print BNX "# rh	SourceFolder	InstrumentSerial	Time	NanoChannelPixelsPerScan	StretchFactor	BasesPerPixel	NumberofScans	ChipId	Flowcell\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																															
print BNX "# Run Data	Z:/2014-03/$ProName/Detect Molecules	A001	3/12/2014 9:11:48 PM	68819821	0.85	490.646637	1	20249,11694,10/2/2013,0011926	1\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																															
print BNX "# Quality Score QX01:	SNR\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							
print BNX "# Quality Score QX02:	Ave Intensity\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							
print BNX "#0h	LabelChannel	MoleculeId	Length	AvgIntensity	SNR	NumberofLabels	OriginalMoleculeId	ScanNumber	ScanDirection	ChipId	Flowcell\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																													
print BNX "#0f	int	int	float	float	float	int	int	int	int	string	int\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																													
print BNX "#1h	LabelChannel	LabelPositions[N]\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						
print BNX "#1f	int	float\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						
print BNX "#2h	LabelChannel	LabelPositions[N]\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						
print BNX "#2h	int	float\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						
print BNX "#Qh	QualityScoreID	QualityScores[N]\n";																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																					
print BNX "#Qf	str	float\n";


srand(time|$$);#产生随机点

####输入长度分布参数，个数，均值，方差
my $Mol_ID=0;
my $MoleculeID;
my @Che_pos=();
my @ids=();
my @BNXprint=();
my @pos_str=();

#先运行FragileSite.pl得到易碎点txt，然后读取该文件数据存入数组

open (IN1, "<$FragileIN")or die "can't open $FragileIN !";
my @FragileIN = <IN1>;
my @FragileINdata=();
shift @FragileIN;#delate head

#pop @FragileIN;#delate end line
foreach my $FragileINdata(@FragileIN) 
	{
		chomp $FragileINdata;
	}
close IN1;


##选择何种酶切类型

my @PosData=();
my @DistanceData=();
#my @Orientation=();
my @genomePre=();
print "enzyme_len total=$enzyme_len\n";
for (my $r=0;$r<$Cov;$r++) #根据cov循环
{

	#读入初始基因组fa文件
	open (GenomeFa,"< $chr_fa") or die "Can't open file:$!";
	@genomePre = <GenomeFa>;
	foreach my $s (@genomePre) 
	{
		chomp $s;
	}
	close GenomeFa;


	#先判断有几条染色体，然后循环几次
	my @ChrSet=grep {$genomePre[$_]=~/^>.+/} 0..$#genomePre;#抓取fa表头行坐标
	#print "@ChrSet\n";
	#my @Size1000_pre=grep{$label_size[$_]<=1000} 0..$#label_size;#将小于1k的间距下标存入数组

	my $ChrNum=@ChrSet;#统计染色体条数
	#print "ChrNum=$ChrNum\n";
	my $chr_len=0;
	my @XChr=();
	for (my $v=1;$v<$ChrNum+1;$v++) 
		{
			my $chrStr=$ChrSet[$v-1]+1;#染色体表头下一行开始
			#print "chrStr=$chrStr\n";
			my $chrEnd;
			if ($v==$ChrNum) 
				{
					$chrEnd=@genomePre-1;#最后一个元素
					#print "chrEnd=$chrEnd\n";
				}
			else
				{
					$chrEnd=$ChrSet[$v]-1;#下一个染色体表头上一行结束
					#print "chrEnd=$chrEnd\n";
				}
			my @ChrGrep=@genomePre[eval($chrStr)..eval($chrEnd)];#截取染色体所有片段
			my $chrPre = join("",@ChrGrep);#存储染色体
			$chr_len=length ($chrPre);
			#print "chr_len=$chr_len\n";
			my @chrfragile=grep {$_=~/^$v\t.+/} @FragileIN;#抓取相应染色体的易碎点区域
			my $ppp=@chrfragile;
			#print "ppp=$ppp\n";
			@PosData=();
			@DistanceData=();
			#@Orientation=();
			foreach my $chrfragile(@chrfragile) 
			{
				my @ChrFragileSet=split(/\t/,$chrfragile);
				#$chr_len=$ChrFragileSet[1];
				push (@PosData,$ChrFragileSet[5]);
				#print "5=$ChrFragileSet[5]\n";
				push (@DistanceData,$ChrFragileSet[6]);
				#print "6=$ChrFragileSet[6]\n";
				#push (@Orientation,$ChrFragileSet[7]);
				#print "7=$ChrFragileSet[7]\n";
			}

			###随机增加易碎点###
			#my ($a,$b,$PosSet,$DistanceSet) = @_; #指数分布两个参数,FragileSite位置，间距
			#my @FragileSites=Fragile::FragileSite($FragileMean1,$FragileSdt1,$FragileMean2,$FragileSdt2,\@PosData,\@DistanceData,\@Orientation);#分辨率均值和方差,FragileSite位置，间距,方向，返回易碎位点数组
			my @FragileSites=Fragile::FragileSite($FragilePa,$FragilePb,\@PosData,\@DistanceData);#分辨率均值和方差,FragileSite位置，间距,方向，返回易碎位点数组

			#print FN "@FragileSites\n";
			#增加结尾点即染色体总长
			#my $FragileSitesEnd=$chr_len+1;
	#		push (@FragileSites,$FragileSitesEnd);
	
			#print FN "@FragileSites\n";
			##根据易碎点截取基因组片段
			my $FraStart=0;
			my $FraEnd=1;
			my $FraLen=0;
			my $FraStr=0;
			my @Chr=();
			foreach my $FraSite (@FragileSites) 
			{
				#print "FraSite=$FraSite \n";
				$FraLen=$FraSite-$FraEnd;
				#print "$FraStart, $FraLen\n";
				$FraStr=substr ($chrPre, $FraStart, $FraLen);#切割
				push (@Chr,$FraStr);
				my $e_pat_Len=length($plus1);#enzyme pattern length
				print "e_pat_Len=$e_pat_Len\n";
				$FraStart=$FraSite+$e_pat_Len-1;#下一个截取起点
				$FraEnd=$FraSite+$e_pat_Len;
			}
			#增加结尾段
			$FraStr=substr ($chrPre, $FraStart);#切割
			push (@Chr,$FraStr);

			my $Chrl=@Chr;
			#print "Chrl=$Chrl\n";
			my $XChr = join("X",@Chr);#连接片段成染色体
			#my $Chrll=length $XChr;
			#print "Chrll=$Chrll\n";
			push (@XChr,$XChr);#把带有易碎点标记的染色体片段存入数组
		}



	#用X连接加了易碎点区域的染色体
	my $genome = join("X",@XChr);#连接带有易碎点标记的染色体呈新的基因组序列，染色体间用X连接
	#my $lll=length $genome;
	#print "lll=$lll\n";

	
	#随机数种子设定
	my $phase=rand(10);
	random_set_seed_from_phrase($phase);

	####产生长度kb随机数


	####输入长度分布参数，个数，均值，方差，产生长度随机数
	
	#切割基因组
	my $str;
	my $dataset_length=0;
	my $rand;
	#my $X_ID;
	my $geno_len=length($genome);
	my $Mol_l=0;
	my @Fa=();
	my $reads;
	
	while ($geno_len!=0) 
	{
		#$dataset_length=@MolLenUp100;
		#$rand=int(rand($dataset_length));#产生一个随机数
		#my $read_length01=int($MolLenUp100[$rand]*1000);#kb要乘以1000转化为bp
		my $read_length01_random=random_exponential(1,$EXPav);#产生一个符合指数分布的分子长度
		my $read_length01=int($read_length01_random*1000);#kb要乘以1000转化为bp
		$str=substr ($genome, 0, $read_length01);#从头开始切割
		#判断是否已切割到接近末尾
		if ($geno_len<=$read_length01) #已接近末尾
			{
				if ($genome=~m/X/) #把剩下的基因组序列输出
				{
					my @reads=split(/X/,$genome); 
					foreach $reads (@reads) 
					{
						#print OUT1">Molecule\n";
						#print OUT1 "$reads\n";
						$Mol_l=length($reads);
						#print OUT2 "$Mol_l\n";
						push (@Fa,$reads);
					}
				}
				else 
				{
					#print OUT1 ">Molecule\n";
					#print OUT1 "$genome\n";
					$Mol_l=length($genome);
					#print OUT2 "$Mol_l\n";
					push (@Fa,$genome);
				}
				$geno_len=0;#切割完毕
			}
		else #尚未到达末尾
		{
			if ($str!~m/X/)#不含有X，即在同一条染色体上，且不含易碎位点
			{
				substr($genome, 0, $read_length01)="";#删除取出的reads
				#print OUT1 ">Molecule\n";
				#print OUT1 "$str\n";
				$Mol_l=length($str);
				#print OUT2 "$Mol_l\n";
				#print OUT2 ">Molecule\n";
				push (@Fa,$str);
			}
			if ($str=~m/X/ && $str!~m/^X/)#含有X，但不以X开头 ，表示可能不在同一染色体或含有易碎点
			{
				#$X_ID=index($str,"X");#查找X的位置
				#$str=substr($genome, 0, $X_ID);#取出开始到前面X处的reads
				#substr($genome, 0, $X_ID+1)="";#删除取出的reads,+1表示包括后面的X
				#$Mol_l=length($str);
				#push (@Fa,$str);

				substr($genome, 0, $read_length01)="";#删除取出的reads
				#将取出的序列在X处断裂:1、易碎点造成的断裂；2、不同染色体序列间断裂
				my @strSplit=split(/X/,$str); 
					foreach my $strSplit (@strSplit) 
					{
						#print OUT1">Molecule\n";
						#print OUT1 "$reads\n";
						$Mol_l=length($strSplit);
						#print OUT2 "$Mol_l\n";
						push (@Fa,$strSplit);
					}
			}
			if ($str=~m/^X/) #含有X，且以X开头 
			{
				substr($str, 1, 1)="";#去掉第一个X
				substr($genome, 0, $read_length01)="";#删除取出的reads
				#print OUT1 ">Molecule\n";
				#print OUT1 "$str\n";
				$Mol_l=length($str);
				#print OUT2 "$Mol_l\n";
				push (@Fa,$str);
			}
			$geno_len=length($genome);
		}
	}
	#print "geno_len=$geno_len\n";
	##一次基因组切割完毕


	##用酶解
	my $fasta_length=@Fa;#计算所有分子总数
	my @CMAPdataset=();
	my $CMAP;
	my $CmapID=1;
	my $string;
	my $str_length;
	my $Numsites;
	my @Pos_all=();
	my @sort_Pos=();
	for (my $t=0;$t<$fasta_length;$t++) 
	{
		$string=$Fa[$t];
		chomp $string;
		$string=uc($string);#把所有字母转换成大写
		$str_length=length ($string);#以bp为单位
		@sort_Pos=();
		@Pos_all=();
		$Numsites=0;
		#print "$enzymes[0]\t$enzymes[1]\n";
		if ($enzyme_len==2) #single
		{
			@Pos_all=Digest::Single($plus1,$minus1,$np1,$string);
			#@Pos_all=Digest::Single($enzymes1,$enzymes2,$string);
		}
		else#dual
		{
			@Pos_all=Digest::Dual($plus1,$minus1,$np1,$plus2,$minus2,$np2,$string);
		}
		my $Pos_length=@Pos_all;
		if ($Pos_length==0) 
		{
			next;
		}
		if ($Pos_length>0) 
		{
			@sort_Pos=(sort {$a<=>$b} @Pos_all);#对酶切位点进行排序
			#print "@sort_Pos\n"; 
			$Numsites=@sort_Pos;
			my $siteid=0;
			for (my $z=0;$z<=$Numsites;$z++) 
			{
				if ($z==$Numsites) 
				{
				$siteid=$z+1;
				$CMAP=join "\t",$CmapID,$str_length,$Numsites,$siteid,0,$str_length,0,1,1;
				#print CMAP "a=$CMAP\n";
				push (@CMAPdataset,$CMAP);
				}
				else
				{
				$siteid=$z+1;
				$CMAP=join "\t",$CmapID,$str_length,$Numsites,$siteid,1,$sort_Pos[$z],0,1,1;
				#print CMAP "b=$CMAP\n";
				push (@CMAPdataset,$CMAP);
				}
			}
		}
		$CmapID++;
	}	
	#print "CmapID=$CmapID\n";
	##############先产生需要嵌合的分子ID
	my @chemericaID=();
	my $mol_Num=$CmapID-1;#有酶切位点的分子总数
	my $cycle=int($mol_Num*$Chi_perc);#一次循环切割产生的分子数*嵌合分子比例
	print "$mol_Num\t$cycle\n";
	#my $cycle=int($fasta_length*$Chi_perc);#一次循环切割产生的分子数*嵌合分子比例
	my %sns;
	my $chemericaID=0;
	my $minimum=1;
	for (my $q=0;$q<$cycle;$q++) 
		{
			#do
			#	{
			#		$chemericaID=int(rand($mol_Num))+$minimum;
			#	}while($sns{$chemericaID} == 1);#防止重复
		
			#先产生一个随机数
			$chemericaID=int(rand($mol_Num))+$minimum;
			while(defined $sns{$chemericaID})#如果有定义了，则表示重复了，需重新产生随机数
				{
					$chemericaID=int(rand($mol_Num))+$minimum;
				}
			$sns{$chemericaID} = 1;
			push (@chemericaID,$chemericaID);
		}
	#############先产生需要嵌合的分子ID


	##############加入错误模型#######################
	for (my $id=1;$id<$CmapID;$id++) #前面的$CmapID大于总分子ID
	{
		
		my @mol=();
		my @mol_1=();
		my @mol_pre=();
		my @pos_str=();
		my @SitePos=();

		@mol_pre=grep /^$id\t\d+\t\d+\t\d+\t\d+\t\d+\t\d+\t\d+\t\d+$/, @CMAPdataset;

		foreach my $molecule (@mol_pre) 
		{
			my @data_03=split(/\t/,$molecule);
			push (@SitePos,$data_03[5]);
		}


		#加入FN位点
		@mol=ErrorMOD::FN ($p_FN,\@SitePos);
		
		#加入FP位点
		@mol_1=ErrorMOD::FP ($lamdaFP,\@mol);#返回的是cmap数组

		
		###挑选需要嵌合的分子，加入嵌合模型#####
		if (grep {$_==$id} @chemericaID) 
			{
				my $Che_pos=join ("t",@mol_1);#注意根据前面的数组名称修改
				push (@Che_pos,$Che_pos);
				$Mol_ID++;
				push (@ids,$Mol_ID);
				next;#跳过下述步骤，检测下一条分子
			}
		###挑选需要嵌合的分子，加入嵌合模型#####


		#分子拉伸
		@pos_str=ErrorMOD::Stretch ($m_str,$sd_str,\@mol_1);#返回的是位置数组

		#########分辨率：保留10%的1kb以下的酶切位点，80%的1kb-1.5kb的位点，其他1500bp以下的位点位置取均值（相加/2）
		#my @RE=Chimera::RES($Mol_ID,$QX11av,$QX11sd,$QX12av,$QX12sd,$under1000,$under1500,\@pos_str);
		#根据RES类型调用合适的RES函数
		my @RES=();
		if ($res==1) 
			{
				@RES=RES::RES1($under1000,$under1500,\@pos_str);
			}
		else 
			{
				@RES=RES::RES2($ResMean,$ResSdt,\@pos_str);
			}

		@BNXprint=&PRINT($Mol_ID,$QX11av,$QX11sd,$QX12av,$QX12sd,\@RES);
		$Mol_ID=$BNXprint[1];

		print BNX "$BNXprint[0]\n";

	}#对应加入错误模型的for循环


}#对应cov的

	#得到所有需要的嵌合的分子后进行嵌合	
	#处理嵌合分子,传入$Mol_ID
	my $isd_len=@ids;
	my $Che_pos_len=@Che_pos;

	my @Che=Chimera::Che($res,$under1000,$under1500,$Chi_Bi,$Chi_Tri,$Chi_Qua,\@ids,\@Che_pos);

	foreach my $Che (@Che) 
		{
			my @Che_dataSet=split(/\t/,$Che);

		####分子拉伸
		@pos_str=ErrorMOD::Stretch ($m_str,$sd_str,\@Che_dataSet);#返回的是位置数组
		
		#########分辨率：保留10%的1kb以下的酶切位点，80%的1kb-1.5kb的位点，其他1500bp以下的位点位置取均值（相加/2）
			my @RE;
			if ($res==1) 
					{
						@RE=RES::RES1($under1000,$under1500,\@pos_str);
					}
				else
					{
						@RE=RES::RES2($ResMean,$ResSdt,\@pos_str);
					}

			@BNXprint=&PRINT($Mol_ID,$QX11av,$QX11sd,$QX12av,$QX12sd,\@RE);
			$Mol_ID=$BNXprint[1];
			print BNX "$BNXprint[0]\n";
		}
		#print "isd_len=$isd_len\n";
		#print "Che_pos_len=$Che_pos_len\n";
		#print Chi "$Chimera::Chi_return\n";

#close OUT1;
#close OUT2;
close BNX;
#close CMAP;
#close FN;
#close FP;
#close STRETCH;
#close Chi;

my $end_time = time();
my $elapsed_time = $end_time - $start_time;    
print "elapsed_time=$elapsed_time\n";



sub PRINT
{
		my ($subMol_ID,$subQX11av,$subQX11sd,$subQX12av,$subQX12sd,$PosNew) = @_; 

		#输入到bnx文件中
		my $PosNew_len=@$PosNew;
		my ($Numsite_new,$MolSNR_total,$MolSNR,$MolIntensity_total,$MolIntensity);
		my @QX11=();
		my @QX12=();
		my @PosNew_new=();
		if ($PosNew_len<=1) 
			{
				$Numsite_new=0;#只剩下一个酶切位点，即分子长度位点,实际没有切点
				$MolSNR=5.0;
				$MolIntensity=1.0;#分子平均Intensity
			}
		else 
			{
				$Numsite_new=$PosNew_len-1;#不只一个酶切位点，总位点数要减去最后一个分子长度位点
				#以总体scan的分布参数为平均值和方差，每次只产生一个SNR，
				@QX11=random_normal($Numsite_new, $QX11av, $QX11sd);#产生SNR随机数,  
				$MolSNR_total=sum @QX11;
				$MolSNR=$MolSNR_total/$Numsite_new;#分子平均SNR
				@QX12=random_normal($Numsite_new, $subQX12av, $subQX12sd);#产生intensity随机数
				$MolIntensity_total=sum @QX12;
				$MolIntensity=$MolIntensity_total/$Numsite_new;#分子平均Intensity				
			}

			$subMol_ID++;

			my $MoleculeLen=0; 
			if ($PosNew_len==0) 
				{
					$MoleculeLen=1;
				}
			else 
				{
					$MoleculeLen=sprintf "%.1f",$$PosNew[-1];
				}
			my $MolSNR_print=sprintf "%.6f",$MolSNR;
			my $MolIntensity_print=sprintf "%.3f",$MolIntensity;
			my @PosNew_print=();
			foreach my $Pos_New(@$PosNew) 
			{
				my $PosNew_print = sprintf "%.1f",$Pos_New;
				push (@PosNew_print,$PosNew_print);
			}
			my @QX11_print=();
			foreach my $QX11 (@QX11) 
			{
				my $QX11_print = sprintf "%.4f",$QX11;
				push (@QX11_print,$QX11_print);
			}
			my @QX12_print=();
			foreach my $QX12 (@QX12) 
			{
				my $QX12_print = sprintf "%.4f",$QX12;
				push (@QX12_print,$QX12_print);
			}

			@QX11_print=join("\t",@QX11_print);
			@QX12_print=join("\t",@QX12_print);
			@PosNew_print=join("\t",@PosNew_print);
			
			my $str="20249,11694,10\/2\/2013,0011926";
			my $return01=join ("\t","0",$subMol_ID,$MoleculeLen,$MolSNR_print,$MolIntensity_print,$Numsite_new,$subMol_ID,"3","-1",$str,"1");
			my $return02=join ("\t","1",@PosNew_print);
			my $return03=join ("\t","QX11",@QX11_print);
			my $return04=join ("\t","QX12",@QX12_print);
			my $return=join ("\n",$return01,$return02,$return03,$return04);

			return ($return,$subMol_ID);
}


################################################################################
##############                  Documentation                 ##################
################################################################################
## style adapted from http://www.perlmonks.org/?node_id=489861 
__END__

=head1 NAME

AssembleIrysXeonPhi.pl - the package of scripts preps raw molecule maps and writes and runs a series of assemblies for them. Then the user selects the best assembly and uses this to super scaffold the reference FASTA genome file and summarize the final assembly metrics and alignments.

The basic steps are to first merge multiple BNXs from a single directory and plot single molecule map quality metrics. Then Rescale single molecule maps and plot rescaling factor per scan (adjusting stretch scan by scan) if reference is available. Writes scripts for assemblies with a range of parameters.

This pipeline uses the same basic workflow as AssembleIrys.pl and AssembleIrysCluster.pl but it runs a Xeon Phi server with 576 cores (48x12-core Intel Xeon CPUs), 256GB of RAM, and Linux CentOS 7 operating system. Customization may be required to run the BioNano Assembler on a different machine.

See tutorial lab to run the assemble XeonPhi pipeline with sample data https://github.com/i5K-KINBRE-script-share/Irys-scaffolding/blob/master/KSU_bioinfo_lab/assemble_XeonPhi/assemble_XeonPhi_LAB.md.


=head1 USAGE

perl AssembleIrysXeonPhi.pl [options]

 Documentation options:
 
   -help    brief help message
   -man	    full documentation
 
 Required options:
 
   -cov     Coverage	     
   -ca      reference genome fasta
   -bnx	      bnx output
   -fragile	     fragile site file
 
 Optional options:
 
   -lm	     length_mean,#possion
   -FNp	     FN_probality,Binomil~
   -FPi	     FP_intensity,possion~lamda
   -str	     stretch_normal,stretch~N(ave,std),comma-separated lists of values
   
   -Rt	     Resolution type
   -RtI	     Res_typeI, under1000,under1500
   -RtII	     Res_typeII, resolution~N(ave,std)

   -snr	     SNR, SNR~N(ave,std)
   -Ints	     Intensity, Intensity~N(ave,std)

   -Chi_perc	 Chi_percent
   -Chi_Bi	 Chi_Bi
   -Chi_Tr    Chi_Tri
   -Chi_Qua    Chi_Qua

   -e	     enzyme nicking pattern
   -np1      nick_position1, nicking position of the enzyme pattern in 5' to 3',
             e.g. NtBspQI: 5' ...GCTCTTCN^... 3' the np1 is 7;    Nb.BsrDI: 5' ...GCAATGNN... 3'  the np1 is -1.
                           3' ...CAGAGNN... 5'                              3' ...CGTTAC^NN... 5'
			 
   -np2      nick_position2
   -p	     project name for all assemblies

   -f	     FragileTypeI

=head1 OPTIONS

=over 8

=item B<-help>

Print a brief help message and exits.

=item B<-man>

Prints the more detailed manual page with output details and exits.


=item B<-a, --assembly_dir>

The assembly working directory for a project. This should include the subdirectory "bnx" (any BNX in this directory will be used in assembly). Use absolute not relative paths. Do not use a trailing "/" for this directory.

=item B<-g, --genome>

The estimated size of the genome in Mb.
 
=item B<-r, --ref>
 
The full path to the reference genome CMAP.

=item B<-p, --project>
 
The project id. This will be used to name all assemblies
 
=item B<-d, --de_novo>

Add this flag to the command if a project is de novo (i.e. has no reference). Any step that requires a reference will then be skipped.

=back

=head1 DESCRIPTION

=cut
